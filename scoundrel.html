<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoundrel - Dungeon Crawler</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-width: 100px;
            --card-height: 140px;
            --accent-color: #d4af37; /* Guld */
            --danger-color: #cf3838;
            --heal-color: #38cf56;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        h1 { margin-bottom: 10px; color: var(--accent-color); }
        
        #game-container {
            max-width: 800px;
            width: 100%;
            display: none; 
            flex-direction: column;
            align-items: center;
        }

        #rules-container {
            max-width: 600px;
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .stat-box { text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8em; color: #aaa; text-transform: uppercase; }

        .room-area {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            min-height: 160px;
        }

        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
        }

        .card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .card-top, .card-bottom { font-size: 1.2em; font-weight: bold; }
        .card-bottom { transform: rotate(180deg); }
        .card-center { font-size: 2.5em; align-self: center; }

        .suit-hearts, .suit-diamonds { color: #d00; }
        .suit-spades, .suit-clubs { color: #000; }

        .controls { display: flex; gap: 20px; }

        button {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: bold;
        }

        .btn-primary { background-color: var(--accent-color); color: #000; }
        .btn-primary:hover { background-color: #e5c14d; }
        
        .btn-danger { background-color: #444; color: #fff; }
        .btn-danger:hover:not(:disabled) { background-color: #666; }
        .btn-danger:disabled { opacity: 0.5; cursor: not-allowed; }

        #log {
            margin-top: 20px;
            width: 100%;
            height: 100px;
            overflow-y: auto;
            background: #111;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            border: 1px solid #333;
        }

        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-damage { color: var(--danger-color); }
        .log-heal { color: var(--heal-color); }
        .log-equip { color: var(--accent-color); }
        .log-discard { color: #888; font-style: italic; }

        .hidden { display: none !important; }
        .weapon-display { color: var(--accent-color); }

    </style>
</head>
<body>

    <div id="rules-container">
        <h1>Scoundrel</h1>
        <p>En dungeon crawler med et almindeligt kortspil.</p>
        
        <h3>Regler</h3>
        <ul>
            <li><strong>Mål:</strong> Kom igennem hele bunken uden at dø.</li>
            <li><strong>HP:</strong> Du starter med 20 liv.</li>
            <li><strong>Rum:</strong> Der ligger 4 kort. Du skal spille 3 af dem. Det sidste bæres med til næste rum.</li>
            <li><strong>Flygt:</strong> Du kan lægge alle 4 kort i bunden af bunken. Du kan ikke flygte to gange i træk.</li>
        </ul>
        <p style="font-size:0.9em; color:#aaa;">*Tip: Hvis du kun har potions tilbage og har brugt en, fjernes de mindste automatisk for at komme videre.</p>

        <button class="btn-primary" onclick="startGame()">Start Spil</button>
    </div>

    <div id="game-container">
        <div class="stats-bar">
            <div class="stat-box">
                <span class="stat-label">Health</span>
                <span class="stat-value" id="hp-display" style="color:var(--heal-color)">20</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Våben</span>
                <span class="stat-value weapon-display" id="weapon-display">Ingen</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Kort i bunke</span>
                <span class="stat-value" id="deck-count">0</span>
            </div>
        </div>

        <div id="message-area" style="margin-bottom:10px; min-height: 20px; font-weight:bold; color: #fff;">
            Vælg et kort...
        </div>

        <div class="room-area" id="room-area">
            </div>

        <div class="controls">
            <button id="flee-btn" class="btn-danger" onclick="fleeRoom()">Flygt fra rummet</button>
            <button id="restart-btn" class="btn-primary hidden" onclick="location.reload()">Spil igen</button>
        </div>

        <div id="log"></div>
    </div>

<script>
    // --- Konstanter ---
    const SUITS = {
        SPADES: '♠', CLUBS: '♣', HEARTS: '♥', DIAMONDS: '♦'
    };
    
    const TYPE = {
        MONSTER: 'monster',
        POTION: 'potion',
        WEAPON: 'weapon'
    };

    // --- Game State ---
    let deck = [];
    let roomCards = [];
    let hp = 20;
    let weapon = null;
    let canFlee = true;
    let cardsPlayedInRoom = 0;
    let potionUsedInRoom = false;
    let gameOver = false;

    // --- Setup Logic ---
    function createDeck() {
        const d = [];
        for (let v = 2; v <= 10; v++) {
            d.push({ suit: SUITS.SPADES, value: v, type: TYPE.MONSTER, color: 'black' });
            d.push({ suit: SUITS.CLUBS, value: v, type: TYPE.MONSTER, color: 'black' });
            d.push({ suit: SUITS.HEARTS, value: v, type: TYPE.POTION, color: 'red' });
            d.push({ suit: SUITS.DIAMONDS, value: v, type: TYPE.WEAPON, color: 'red' });
        }
        
        const faces = [
            { name: 'J', val: 11 }, { name: 'Q', val: 12 }, 
            { name: 'K', val: 13 }, { name: 'A', val: 14 }
        ];

        faces.forEach(f => {
            d.push({ suit: SUITS.SPADES, value: f.val, display: f.name, type: TYPE.MONSTER, color: 'black' });
            d.push({ suit: SUITS.CLUBS, value: f.val, display: f.name, type: TYPE.MONSTER, color: 'black' });
        });
        
        return shuffle(d);
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startGame() {
        document.getElementById('rules-container').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        
        deck = createDeck();
        hp = 20;
        weapon = null;
        canFlee = true;
        gameOver = false;
        
        dealRoom(true);
        updateUI();
        log("Spillet er startet. Held og lykke!");
    }

    // --- Core Game Logic ---

    function dealRoom(isFirstRoom = false) {
        roomCards = roomCards.filter(c => c !== null);
        const cardsNeeded = 4 - roomCards.length;

        if (deck.length === 0 && roomCards.length <= 1) {
            winGame();
            return;
        }

        for (let i = 0; i < cardsNeeded; i++) {
            if (deck.length > 0) {
                roomCards.push(deck.pop());
            }
        }

        cardsPlayedInRoom = 0;
        potionUsedInRoom = false;
    }

    function cardClicked(index) {
        if (gameOver) return;
        
        const card = roomCards[index];
        if (!card) return;

        let turnSuccess = false;

        if (card.type === TYPE.MONSTER) {
            handleMonsterCombat(card);
            turnSuccess = true;
        } 
        else if (card.type === TYPE.WEAPON) {
            weapon = { value: card.value };
            log(`<span class="log-equip">Udstyret våben: ${card.value}</span>`);
            turnSuccess = true;
        } 
        else if (card.type === TYPE.POTION) {
            if (potionUsedInRoom) {
                showMessage("Du har allerede brugt en potion i dette rum!");
                return;
            }
            const healAmount = card.value;
            const oldHp = hp;
            hp = Math.min(20, hp + healAmount);
            potionUsedInRoom = true;
            log(`<span class="log-heal">Healede ${hp - oldHp} HP (Kort: ${card.value})</span>`);
            turnSuccess = true;
        }

        if (turnSuccess) {
            roomCards[index] = null;
            cardsPlayedInRoom++;
            checkRoomStatus();
            updateUI();
        }
    }

    function handleMonsterCombat(card) {
        let damage = 0;
        let monsterVal = card.value;

        if (weapon) {
            if (weapon.value >= monsterVal) {
                damage = 0;
                log(`Dræbte monster (${monsterVal}) med våben. Ingen skade.`);
            } else {
                damage = monsterVal - weapon.value;
                log(`<span class="log-damage">Våben svagt. Du tog ${damage} skade.</span>`);
            }
            weapon.value = Math.min(weapon.value, monsterVal);
        } else {
            damage = monsterVal;
            log(`<span class="log-damage">Bare næver mod monster (${monsterVal}). ${damage} skade.</span>`);
        }

        hp -= damage;
        if (hp <= 0) {
            hp = 0;
            loseGame();
        }
    }

    function checkRoomStatus() {
        // --- RETTELSE: Tjek om vi er låst fast (kun potions tilbage) ---
        const unplayed = roomCards.map((c, i) => ({card: c, index: i})).filter(item => item.card !== null);
        const onlyPotions = unplayed.length > 0 && unplayed.every(item => item.card.type === TYPE.POTION);

        // Hvis vi har brugt potion, kun har potions tilbage, og mangler at spille kort:
        if (potionUsedInRoom && onlyPotions && cardsPlayedInRoom < 3) {
            
            // Vi skal spille op til 3 kort. Vi fjerner de laveste hjerter.
            const needed = 3 - cardsPlayedInRoom;
            
            // Sorter efter værdi (lavest først)
            unplayed.sort((a, b) => a.card.value - b.card.value);
            
            let discardedCount = 0;
            
            for (let i = 0; i < needed; i++) {
                // Sikkerhedscheck, hvis der ikke er nok kort
                if (i < unplayed.length) {
                    const item = unplayed[i];
                    // Fjern kortet (sæt til null)
                    roomCards[item.index] = null;
                    log(`<span class="log-discard">Smed ${item.card.value}♥ væk (kun 1 potion tilladt).</span>`);
                    discardedCount++;
                }
            }
            
            cardsPlayedInRoom += discardedCount;
            showMessage("Overskydende potions fjernet automatisk.");
        }
        // --- SLUT PÅ RETTELSE ---

        if (cardsPlayedInRoom >= 3) {
            setTimeout(() => {
                canFlee = true;
                dealRoom();
                updateUI();
            }, 800);
        }
    }

    function fleeRoom() {
        if (!canFlee) {
            showMessage("Du kan ikke flygte to gange i træk!");
            return;
        }
        if (cardsPlayedInRoom > 0) {
            showMessage("Du kan kun flygte før du spiller kort!");
            return;
        }

        const cardsToMove = roomCards.filter(c => c !== null);
        deck.unshift(...cardsToMove);
        
        log("Du flygtede! Kort lagt i bunden.");
        
        roomCards = [];
        canFlee = false;
        dealRoom();
        updateUI();
    }

    function updateUI() {
        document.getElementById('hp-display').innerText = hp;
        document.getElementById('deck-count').innerText = deck.length;
        
        const wDisplay = document.getElementById('weapon-display');
        if (weapon) {
            wDisplay.innerText = `${weapon.value} ♦`;
        } else {
            wDisplay.innerText = "Ingen";
        }

        const fleeBtn = document.getElementById('flee-btn');
        fleeBtn.disabled = !canFlee || cardsPlayedInRoom > 0;

        renderCards();
    }

    function renderCards() {
        const container = document.getElementById('room-area');
        container.innerHTML = '';

        roomCards.forEach((card, index) => {
            if (card === null) return;

            const el = document.createElement('div');
            el.className = `card ${potionUsedInRoom && card.type === TYPE.POTION ? 'disabled' : ''}`;
            el.style.color = card.color;
            el.onclick = () => cardClicked(index);

            const displayVal = card.display || card.value;
            let suitClass = '';
            if (card.suit === SUITS.HEARTS) suitClass = 'suit-hearts';
            else if (card.suit === SUITS.DIAMONDS) suitClass = 'suit-diamonds';
            else suitClass = 'suit-spades'; // Sorte kort

            el.innerHTML = `
                <div class="card-top ${suitClass}">${displayVal} ${card.suit}</div>
                <div class="card-center ${suitClass}">${card.suit}</div>
                <div class="card-bottom ${suitClass}">${displayVal} ${card.suit}</div>
            `;
            container.appendChild(el);
        });
    }

    function showMessage(msg) {
        document.getElementById('message-area').innerText = msg;
        setTimeout(() => document.getElementById('message-area').innerText = "Vælg et kort...", 3000);
    }

    function log(msg) {
        const logEl = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `> ${msg}`;
        logEl.prepend(entry);
    }

    function winGame() {
        gameOver = true;
        document.getElementById('room-area').innerHTML = '<h2 style="color:#38cf56">Du vandt! Fangekælderen er tom.</h2>';
        document.getElementById('flee-btn').classList.add('hidden');
        document.getElementById('restart-btn').classList.remove('hidden');
    }

    function loseGame() {
        gameOver = true;
        document.getElementById('room-area').innerHTML = '<h2 style="color:#cf3838">Du døde!</h2>';
        document.getElementById('flee-btn').classList.add('hidden');
        document.getElementById('restart-btn').classList.remove('hidden');
    }

</script>
</body>
</html>
