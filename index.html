<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoundrel - Dungeon Crawler</title>
    <style>
        :root {
            --bg-dark: #121215;
            --stone-dark: #1a1a20;
            --stone-light: #252530;
            --text-color: #dcdcd0;
            --card-width: 110px;
            --card-height: 154px;
            --accent-color: #ffcc00;
            --danger-color: #ff4444;
            --heal-color: #66ff66;
            --card-bg: #e6d2b5; /* Pergament */
        }

        body {
            font-family: 'Segoe UI', Tahoma, 'Courier New', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            user-select: none;
            
            /* Dungeon Background CSS Generator */
            background-color: var(--bg-dark);
            background-image: 
                /* Slyngplanter / Gr√∏n t√•ge bund */
                linear-gradient(to top, rgba(20, 50, 20, 0.4), transparent 30%),
                /* Vignette */
                radial-gradient(circle at 50% 50%, transparent 50%, #000 100%),
                /* Sten m√∏nster */
                linear-gradient(335deg, var(--stone-dark) 23px, transparent 23px),
                linear-gradient(155deg, var(--stone-light) 23px, transparent 23px),
                linear-gradient(335deg, var(--stone-dark) 23px, transparent 23px),
                linear-gradient(155deg, var(--stone-light) 23px, transparent 23px);
            background-size: 100% 100%, 100% 100%, 58px 58px, 58px 58px, 58px 58px, 58px 58px;
            background-position: 0 0, 0 0, 0px 2px, 4px 35px, 29px 31px, 34px 6px;
        }

        h1 {
            font-family: 'Georgia', serif;
            color: var(--accent-color);
            text-shadow: 2px 2px 0px #000;
            font-size: 2.8em;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        /* --- UI Containers --- */
        #game-container {
            max-width: 900px;
            width: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        #start-screen, #win-screen {
            max-width: 500px;
            background: rgba(20, 20, 25, 0.95);
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            border: 2px solid #555;
            text-align: center;
            position: relative;
            z-index: 100;
            margin-top: 50px;
        }

        #win-screen { display: none; }

        /* --- Stats Bar --- */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            width: 100%;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .stat-box { text-align: center; }
        .stat-value { font-size: 1.8em; font-weight: bold; text-shadow: 2px 2px 0 #000; }
        .stat-label { font-size: 0.75em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* --- Room Area (Cards) --- */
        .room-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            min-height: 180px;
            padding: 10px;
        }

        /* --- CARD DESIGN (Fr√∏nnet look) --- */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: var(--card-bg);
            /* Papir tekstur via st√∏j */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            border-radius: 6px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 
                inset 0 0 20px rgba(60, 40, 10, 0.4), /* Indre snavs/skygge */
                2px 2px 6px rgba(0,0,0,0.6);         /* Ydre skygge */
            border: 1px solid rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            box-sizing: border-box;
            color: #222;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            z-index: 10;
        }

        .card.disabled {
            opacity: 0.5;
            filter: grayscale(80%);
            cursor: not-allowed;
            transform: none !important;
        }

        .card.selected-target {
            border: 3px solid var(--danger-color);
            box-shadow: 0 0 15px var(--danger-color);
            transform: scale(1.05);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--danger-color); }
            50% { box-shadow: 0 0 25px var(--danger-color); }
            100% { box-shadow: 0 0 10px var(--danger-color); }
        }

        .card-corner { font-size: 1.1em; font-weight: bold; line-height: 1; }
        .card-corner.bottom { transform: rotate(180deg); text-align: left; }
        .card-center-icon { font-size: 3.5em; align-self: center; opacity: 0.9; text-shadow: 0 2px 0 rgba(0,0,0,0.1); }

        .suit-hearts { color: #8a0000; }
        .suit-diamonds { color: #b36b00; }
        .suit-spades, .suit-clubs { color: #1a1a1a; }

        /* --- Action Bar (Kamp knapper) --- */
        #action-bar {
            height: 70px;
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .combat-btn {
            display: none; /* Skjult indtil relevant */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 160px;
            height: 60px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            color: #fff;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }

        .combat-btn span.sub { font-size: 0.7em; font-weight: normal; opacity: 0.9; text-transform: none; }
        .combat-btn:active { transform: translateY(2px); }

        .btn-weapon { background: linear-gradient(#b8860b, #8b6508); display: none; }
        .btn-weapon:hover { background: linear-gradient(#d4af37, #a87b08); border-color: #fff; }
        
        .btn-bare { background: linear-gradient(#a33, #822); display: none; }
        .btn-bare:hover { background: linear-gradient(#c44, #a22); border-color: #fff; }

        /* Generelle knapper */
        .btn-std {
            padding: 12px 30px;
            font-size: 1.1em;
            background: #d4af37;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 #8b6508;
        }
        .btn-std:hover { background: #e5c14d; }
        .btn-std:active { transform: translateY(2px); box-shadow: 0 1px 0 #8b6508; }

        .btn-flee {
            background: #444; color: #ccc;
            padding: 10px 20px;
            border-radius: 4px; border: 1px solid #666;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-flee:hover:not(:disabled) { background: #555; color: #fff; }
        .btn-flee:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Log --- */
        #log {
            width: 100%;
            height: 120px;
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            border: 1px solid #333;
            color: #ccc;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas" style="position:fixed; top:0; left:0; pointer-events:none; z-index:999;"></canvas>

    <div id="start-screen">
        <h1>Scoundrel</h1>
        <p style="color:#aaa;">Dungeon crawler med 52 kort.</p>
        <div style="text-align:left; background:rgba(0,0,0,0.5); padding:15px; border-radius:5px; margin:20px 0; font-size:0.9em;">
            <strong style="color:var(--accent-color)">Regler:</strong><br>
            ‚Ä¢ 4 kort i rummet. Spil 3. Sidste kort f√∏lger med.<br>
            ‚Ä¢ <strong>‚ô• Drikke:</strong> Healer dig. Max 1 pr. rum.<br>
            ‚Ä¢ <strong>‚ô¶ V√•ben:</strong> Udstyr v√•ben. Mister styrke ved brug.<br>
            ‚Ä¢ <strong>‚ô†/‚ô£ Monstre:</strong> V√¶lg v√•ben eller n√¶ver.
        </div>
        <button class="btn-std" id="btn-start">G√• ind i m√∏rket</button>
    </div>

    <div id="win-screen">
        <h1 style="color:var(--heal-color)">SEJR!</h1>
        <p>Du overlevede fangek√¶lderen.</p>
        <p id="final-score" style="font-size:1.5em; margin:20px 0;"></p>
        <button class="btn-std" onclick="location.reload()">Spil Igen</button>
    </div>

    <div id="game-container">
        
        <div class="stats-bar">
            <div class="stat-box">
                <span class="stat-label">Helbred</span>
                <span class="stat-value" id="hp-display" style="color:var(--heal-color)">20</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">V√•ben</span>
                <span class="stat-value" id="weapon-display">Ingen</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Bunken</span>
                <span class="stat-value" id="deck-count">0</span>
            </div>
        </div>

        <div id="message-area" style="margin-bottom:10px; min-height:24px; font-weight:bold; color:#fff; text-align:center;">
            V√¶lg et kort...
        </div>

        <div class="room-area" id="room-area"></div>

        <div id="action-bar">
            <button id="btn-use-weapon" class="combat-btn btn-weapon">
                ‚öîÔ∏è Brug V√•ben
                <span class="sub" id="lbl-weapon-dmg">0 Skade</span>
            </button>
            <button id="btn-use-fist" class="combat-btn btn-bare">
                üëä Bare N√¶ver
                <span class="sub" id="lbl-fist-dmg">-5 HP</span>
            </button>
        </div>

        <div style="margin-bottom:15px;">
            <button id="flee-btn" class="btn-flee">üèÉ Flygt fra rum</button>
        </div>

        <div id="log"></div>

    </div>

<script>
    // --- Config & State ---
    const SUITS = { SPADES: '‚ô†', CLUBS: '‚ô£', HEARTS: '‚ô•', DIAMONDS: '‚ô¶' };
    const TYPE = { MONSTER: 'monster', POTION: 'potion', WEAPON: 'weapon' };

    let deck = [];
    let roomCards = []; // Array of card objects or null
    let hp = 20;
    let weapon = null; // { value: int }
    let canFlee = true;
    let cardsPlayedInRoom = 0;
    let potionUsedInRoom = false;
    
    // Kamp State
    let selectedMonsterIndex = -1; // Index p√• kortet vi vil angribe

    // --- Init ---
    document.getElementById('btn-start').addEventListener('click', startGame);
    document.getElementById('flee-btn').addEventListener('click', fleeRoom);
    
    const btnWeapon = document.getElementById('btn-use-weapon');
    const btnFist = document.getElementById('btn-use-fist');

    btnWeapon.addEventListener('click', () => resolveCombat(true));
    btnFist.addEventListener('click', () => resolveCombat(false));

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        deck = createDeck();
        hp = 20;
        weapon = null;
        canFlee = true;
        cardsPlayedInRoom = 0;
        potionUsedInRoom = false;
        dealRoom(true);
        updateUI();
        log("Spillet er startet.");
    }

    function createDeck() {
        let d = [];
        // 2-10
        for(let v=2; v<=10; v++) {
            d.push({s:SUITS.SPADES, v:v, t:TYPE.MONSTER});
            d.push({s:SUITS.CLUBS, v:v, t:TYPE.MONSTER});
            d.push({s:SUITS.HEARTS, v:v, t:TYPE.POTION});
            d.push({s:SUITS.DIAMONDS, v:v, t:TYPE.WEAPON});
        }
        // Faces
        [{n:'J',v:11},{n:'Q',v:12},{n:'K',v:13},{n:'A',v:14}].forEach(f => {
            d.push({s:SUITS.SPADES, v:f.v, d:f.n, t:TYPE.MONSTER});
            d.push({s:SUITS.CLUBS, v:f.v, d:f.n, t:TYPE.MONSTER});
        });
        
        // Shuffle
        for(let i=d.length-1; i>0; i--) {
            const j = Math.floor(Math.random()*(i+1));
            [d[i], d[j]] = [d[j], d[i]];
        }
        return d;
    }

    function dealRoom() {
        roomCards = roomCards.filter(c => c !== null);
        
        // Win condition check
        if(deck.length === 0 && roomCards.length <= 1) {
            winGame();
            return;
        }

        while(roomCards.length < 4 && deck.length > 0) {
            roomCards.push(deck.pop());
        }
        cardsPlayedInRoom = 0;
        potionUsedInRoom = false;
        deselectMonster();
    }

    // --- Interaction ---
    function cardClicked(index) {
        const card = roomCards[index];
        if(!card) return;

        // Hvis man klikker p√• et andet kort mens man har valgt et monster, afbryd valg
        if (selectedMonsterIndex !== -1 && selectedMonsterIndex !== index) {
            deselectMonster();
        }

        if(card.t === TYPE.MONSTER) {
            // HVIS vi har et v√•ben, skal vi v√¶lge angrebsmetode
            if (weapon) {
                // Toggle selection
                if (selectedMonsterIndex === index) {
                    deselectMonster(); // Klikkede p√• sig selv -> afmarker
                } else {
                    selectMonster(index);
                }
            } else {
                // Ingen v√•ben -> direkte kamp (n√¶ver)
                selectedMonsterIndex = index;
                resolveCombat(false);
            }
        }
        else if(card.t === TYPE.WEAPON) {
            weapon = { value: card.v };
            log(`Udstyrede v√•ben ${card.v}.`);
            finishCard(index);
        }
        else if(card.t === TYPE.POTION) {
            if(potionUsedInRoom) {
                msg("Du har allerede drukket i dette rum!");
                return;
            }
            let heal = card.v;
            let old = hp;
            hp = Math.min(20, hp + heal);
            potionUsedInRoom = true;
            log(`Healede ${hp-old} HP.`);
            finishCard(index);
        }
    }

    // --- Combat Logic ---
    function selectMonster(index) {
        selectedMonsterIndex = index;
        const card = roomCards[index];
        
        // Vis knapper
        btnFist.style.display = "flex";
        btnWeapon.style.display = "flex";
        
        // Opdater labels p√• knapper
        const dmgBare = card.v;
        document.getElementById('lbl-fist-dmg').innerText = `Tag ${dmgBare} skade`;
        
        let dmgWep = 0;
        if(weapon.value >= card.v) dmgWep = 0;
        else dmgWep = card.v - weapon.value;
        
        let nextWepVal = Math.min(weapon.value, card.v);
        
        document.getElementById('lbl-weapon-dmg').innerText = 
            `Tag ${dmgWep} skade (V√•ben -> ${nextWepVal})`;

        updateUI(); 
        msg("V√¶lg angreb nedenfor!");
    }

    function deselectMonster() {
        selectedMonsterIndex = -1;
        btnFist.style.display = "none";
        btnWeapon.style.display = "none";
        msg("V√¶lg et kort...");
        updateUI();
    }

    function resolveCombat(useWeapon) {
        if(selectedMonsterIndex === -1) return;
        
        const card = roomCards[selectedMonsterIndex];
        let dmg = 0;
        
        if(useWeapon && weapon) {
            if(weapon.value >= card.v) {
                dmg = 0;
                log(`Dr√¶bte monster (${card.v}) fejlfrit.`);
            } else {
                dmg = card.v - weapon.value;
                log(`V√•ben for svagt. Tog ${dmg} skade.`);
            }
            weapon.value = Math.min(weapon.value, card.v);
        } else {
            dmg = card.v;
            log(`Sloges med n√¶verne. Tog ${dmg} skade.`);
        }
        
        hp -= dmg;
        if(hp <= 0) {
            hp = 0;
            updateUI();
            gameOver();
            return;
        }
        
        deselectMonster(); // Skjul knapper
        finishCard(selectedMonsterIndex); // Fjern kort
    }

    function finishCard(index) {
        roomCards[index] = null;
        cardsPlayedInRoom++;
        
        // Auto-discard logic for potions
        checkStuck();

        if(cardsPlayedInRoom >= 3) {
            canFlee = true;
            setTimeout(() => {
                dealRoom();
                updateUI();
            }, 600);
        }
        updateUI();
    }

    function checkStuck() {
        // Tjekker om der kun er potions tilbage og vi har brugt en
        let activeCards = roomCards.map((c,i)=>({c,i})).filter(x=>x.c!==null);
        let onlyPotions = activeCards.every(x => x.c.t === TYPE.POTION);
        
        if(potionUsedInRoom && onlyPotions && cardsPlayedInRoom < 3) {
            let needed = 3 - cardsPlayedInRoom;
            activeCards.sort((a,b) => a.c.v - b.c.v); // Laveste f√∏rst
            
            for(let i=0; i<needed; i++) {
                if(i < activeCards.length) {
                    roomCards[activeCards[i].i] = null;
                    log(`Smed potion ${activeCards[i].c.v} v√¶k (regel).`);
                    cardsPlayedInRoom++;
                }
            }
        }
    }

    function fleeRoom() {
        if(!canFlee || cardsPlayedInRoom > 0) {
            msg("Du kan ikke flygte nu.");
            return;
        }
        let leftover = roomCards.filter(c => c!==null);
        deck.unshift(...leftover);
        roomCards = [];
        canFlee = false;
        log("Flygtede fra rummet!");
        dealRoom();
        updateUI();
    }

    // --- UI Render ---
    function updateUI() {
        document.getElementById('hp-display').innerText = hp;
        document.getElementById('deck-count').innerText = deck.length;
        
        let wElem = document.getElementById('weapon-display');
        if(weapon) {
            wElem.innerHTML = `${getIcon(TYPE.WEAPON, weapon.value)} ${weapon.value}`;
            wElem.style.color = "var(--accent-color)";
        } else {
            wElem.innerText = "Ingen";
            wElem.style.color = "#aaa";
        }

        document.getElementById('flee-btn').disabled = (!canFlee || cardsPlayedInRoom > 0);

        // Render Cards
        const container = document.getElementById('room-area');
        container.innerHTML = "";
        
        roomCards.forEach((c, i) => {
            if(!c) return; // Skip tomme slots
            
            let el = document.createElement('div');
            let disabled = (potionUsedInRoom && c.t === TYPE.POTION);
            let isTarget = (i === selectedMonsterIndex);
            
            el.className = `card ${disabled?'disabled':''} ${isTarget?'selected-target':''}`;
            el.onclick = () => { if(!disabled) cardClicked(i); };
            
            // Icon logic
            let icon = getIcon(c.t, c.v);
            let valStr = c.d || c.v;
            
            let suitClass = '';
            if(c.s === SUITS.HEARTS) suitClass = 'suit-hearts';
            else if(c.s === SUITS.DIAMONDS) suitClass = 'suit-diamonds';
            else suitClass = 'suit-spades';

            el.innerHTML = `
                <div class="card-corner ${suitClass}">${valStr} ${c.s}</div>
                <div class="card-center-icon">${icon}</div>
                <div class="card-corner bottom ${suitClass}">${valStr} ${c.s}</div>
            `;
            
            // Random rotation for natural look
            // Gem rotationen baseret p√• index for at den ikke hopper ved re-render
            let rot = (i * 7 + 3) % 4 - 2; // pseudo random -2 til 2 deg
            el.style.transform = isTarget ? "scale(1.05)" : `rotate(${rot}deg)`;
            
            container.appendChild(el);
        });
    }

    function getIcon(type, v) {
        if(type===TYPE.POTION) return 'üß™';
        if(type===TYPE.WEAPON) {
            if(v<=5) return 'üó°Ô∏è';
            if(v<=8) return '‚öîÔ∏è';
            return 'ü™ì';
        }
        if(type===TYPE.MONSTER) {
            if(v<=5) return 'üêÄ';
            if(v<=8) return 'üßü';
            if(v<=10) return 'üê∫';
            if(v===11) return 'üßõ';
            if(v===12) return 'ü¶Ç';
            if(v===13) return 'üëπ';
            return 'üêâ';
        }
        return '';
    }

    function msg(txt) {
        document.getElementById('message-area').innerText = txt;
    }

    function log(txt) {
        let l = document.getElementById('log');
        let d = document.createElement('div');
        d.className = 'log-line';
        d.innerText = "> " + txt;
        l.prepend(d);
    }

    function winGame() {
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('win-screen').style.display = 'block';
        document.getElementById('final-score').innerText = `Liv tilbage: ${hp}`;
        confetti();
    }
    
    function gameOver() {
        document.getElementById('room-area').innerHTML = 
            "<h2 style='color:red; width:100%; text-align:center;'>DU ER D√òD</h2>";
        setTimeout(() => {
             if(confirm("Du d√∏de! Pr√∏v igen?")) location.reload();
        }, 500);
    }

    // Simple Confetti
    function confetti() {
        const c = document.getElementById('confetti-canvas');
        const x = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        let p = [];
        for(let i=0;i<100;i++) p.push({x:Math.random()*c.width, y:Math.random()*c.height-c.height, c:['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)], s:Math.random()*5+5});
        function loop() {
            x.clearRect(0,0,c.width,c.height);
            p.forEach(o=>{o.y+=3; if(o.y>c.height)o.y=0; x.fillStyle=o.c; x.fillRect(o.x,o.y,o.s,o.s);});
            requestAnimationFrame(loop);
        }
        loop();
    }

</script>
</body>
</html>
